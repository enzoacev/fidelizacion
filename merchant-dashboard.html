<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercio - Loyalty MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="merchantApp()" x-cloak class="min-h-screen">
        
        <!-- NAVBAR -->
        <nav class="bg-indigo-600 text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Dashboard Comercio</h1>
                    <p class="text-indigo-200 text-sm" x-text="businessName"></p>
                </div>
                <button @click="logout" class="bg-indigo-800 px-4 py-2 rounded hover:bg-indigo-900">Salir</button>
            </div>
        </nav>

        <!-- TABS -->
        <div class="bg-white border-b shadow-sm">
            <div class="container mx-auto flex">
                <button @click="tab = 'stats'" 
                    :class="tab === 'stats' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'"
                    class="px-6 py-4 font-semibold hover:text-indigo-600">üìä Estad√≠sticas</button>
                <button @click="tab = 'rewards'" 
                    :class="tab === 'rewards' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'"
                    class="px-6 py-4 font-semibold hover:text-indigo-600">üéÅ Recompensas</button>
                <button @click="tab = 'coupons'" 
                    :class="tab === 'coupons' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'"
                    class="px-6 py-4 font-semibold hover:text-indigo-600">üéüÔ∏è Cupones</button>
                <button @click="tab = 'config'" 
                    :class="tab === 'config' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600'"
                    class="px-6 py-4 font-semibold hover:text-indigo-600">‚öôÔ∏è Configuraci√≥n</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="container mx-auto p-6">
            
            <!-- STATS TAB -->
            <div x-show="tab === 'stats'" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-gray-500 text-sm font-semibold">TRANSACCIONES</div>
                    <div class="text-3xl font-bold text-indigo-600 mt-2" x-text="stats.transactions_total"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-gray-500 text-sm font-semibold">CUPONES TOTALES</div>
                    <div class="text-3xl font-bold text-blue-600 mt-2" x-text="stats.coupons_total"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-gray-500 text-sm font-semibold">CANJEADOS</div>
                    <div class="text-3xl font-bold text-green-600 mt-2" x-text="stats.coupons_redeemed"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="text-gray-500 text-sm font-semibold">PENDIENTES</div>
                    <div class="text-3xl font-bold text-orange-600 mt-2" x-text="stats.coupons_pending"></div>
                </div>
            </div>

            <!-- REWARDS TAB -->
            <div x-show="tab === 'rewards'" class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold mb-6">Mis Recompensas</h2>
                
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-semibold mb-4">Crear Nueva Recompensa</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" x-model="newReward.name" placeholder="Nombre de recompensa" 
                            class="p-3 border rounded focus:ring-2 focus:ring-indigo-500">
                        <input type="text" x-model="newReward.description" placeholder="Descripci√≥n"
                            class="p-3 border rounded focus:ring-2 focus:ring-indigo-500">
                        <input type="number" x-model.number="newReward.stamps" placeholder="Sellos requeridos" min="1"
                            class="p-3 border rounded focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button @click="createReward" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-semibold">
                        ‚ûï Crear Recompensa
                    </button>
                </div>

                <div x-show="rewards.length === 0" class="text-center py-8 text-gray-500">
                    <p>Sin recompensas configuradas</p>
                </div>

                <div x-show="rewards.length > 0" class="space-y-3">
                    <template x-for="reward in rewards" :key="reward.id">
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg" x-text="reward.name"></h4>
                                    <p class="text-gray-600" x-text="reward.description"></p>
                                    <p class="text-sm text-indigo-600 font-semibold mt-2">
                                        <span x-text="reward.stamps"></span> sellos requeridos
                                    </p>
                                </div>
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm font-semibold">Activa</span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- COUPONS TAB -->
            <div x-show="tab === 'coupons'" class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold mb-6">Cupones Generados</h2>
                
                <div x-show="coupons.length === 0" class="text-center py-8 text-gray-500">
                    <p>Sin cupones a√∫n</p>
                </div>

                <div x-show="coupons.length > 0" class="space-y-3">
                    <template x-for="coupon in coupons" :key="coupon.id">
                        <div :class="coupon.redeemed ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'" 
                            class="border rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold" x-text="coupon.customer_email"></p>
                                    <p class="text-gray-600" x-text="coupon.reward_name"></p>
                                    <p class="text-sm text-gray-500" x-text="coupon.reward_description"></p>
                                    <p class="text-xs text-gray-400 mt-2">
                                        Creado: <span x-text="new Date(coupon.created_at).toLocaleDateString()"></span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span x-show="!coupon.redeemed" class="bg-orange-100 text-orange-800 px-3 py-1 rounded text-sm font-semibold">
                                        Pendiente
                                    </span>
                                    <span x-show="coupon.redeemed" class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm font-semibold">
                                        ‚úì Canjeado
                                    </span>
                                    <button x-show="!coupon.redeemed" @click="redeemCoupon(coupon.id)" 
                                        class="block mt-2 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                                        Canjear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- CONFIG TAB -->
            <div x-show="tab === 'config'" class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold mb-6">Configuraci√≥n</h2>
                
                <div class="max-w-md">
                    <label class="block font-semibold mb-2">Tipo de Fidelizaci√≥n</label>
                    <select x-model="config.fidelization_type" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-500">
                        <option value="qr">QR (Recomendado)</option>
                        <option value="dni">DNI del Cliente</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-2">
                        <span x-show="config.fidelization_type === 'qr'">Los clientes escanean un QR para obtener sellos</span>
                        <span x-show="config.fidelization_type === 'dni'">Ingresas el DNI del cliente para asignar sellos</span>
                    </p>
                    <button @click="saveConfig" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-semibold">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        function merchantApp() {
            return {
                token: localStorage.getItem('access_token'),
                role: localStorage.getItem('user_role'),
                businessName: '',
                tab: 'stats',
                loading: true,
                
                stats: {
                    transactions_total: 0,
                    coupons_total: 0,
                    coupons_redeemed: 0,
                    coupons_pending: 0
                },
                
                rewards: [],
                newReward: { name: '', description: '', stamps: 10 },
                coupons: [],
                config: { fidelization_type: 'qr' },

                async init() {
                    if (!this.token || this.role !== 'merchant') {
                        alert("Acceso solo para comercios");
                        window.location.href = "/";
                        return;
                    }
                    
                    try {
                        await this.loadDashboard();
                        await this.loadRewards();
                        await this.loadCoupons();
                        await this.loadConfig();
                    } catch (e) {
                        alert("Error cargando datos");
                        console.error(e);
                    }
                    this.loading = false;
                },

                async loadDashboard() {
                    const res = await axios.get('/api/merchant/dashboard', {
                        headers: { Authorization: `Bearer ${this.token}` }
                    });
                    this.stats = res.data;
                    this.businessName = res.data.business_name;
                },

                async loadRewards() {
                    const res = await axios.get('/api/merchant/rewards', {
                        headers: { Authorization: `Bearer ${this.token}` }
                    });
                    this.rewards = res.data;
                },

                async loadCoupons() {
                    const res = await axios.get('/api/merchant/coupons', {
                        headers: { Authorization: `Bearer ${this.token}` }
                    });
                    this.coupons = res.data;
                },

                async loadConfig() {
                    const res = await axios.get('/api/merchant/config', {
                        headers: { Authorization: `Bearer ${this.token}` }
                    });
                    this.config = res.data;
                },

                async createReward() {
                    if (!this.newReward.name || !this.newReward.description || !this.newReward.stamps) {
                        alert("Completa todos los campos");
                        return;
                    }
                    
                    try {
                        await axios.post('/api/merchant/rewards', {
                            reward_name: this.newReward.name,
                            reward_description: this.newReward.description,
                            stamps_required: this.newReward.stamps
                        }, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        });
                        this.newReward = { name: '', description: '', stamps: 10 };
                        await this.loadRewards();
                        alert("Recompensa creada");
                    } catch (e) {
                        alert("Error creando recompensa");
                    }
                },

                async redeemCoupon(couponId) {
                    try {
                        await axios.put(`/api/merchant/coupon/${couponId}/redeem`, {}, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        });
                        await this.loadCoupons();
                        await this.loadDashboard();
                        alert("Cup√≥n canjeado");
                    } catch (e) {
                        alert("Error canjeando cup√≥n");
                    }
                },

                async saveConfig() {
                    try {
                        await axios.put('/api/merchant/config', this.config, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        });
                        alert("Configuraci√≥n guardada");
                    } catch (e) {
                        alert("Error guardando configuraci√≥n");
                    }
                },

                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user_role');
                    window.location.href = "/";
                }
            };
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('merchantApp', merchantApp);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const element = document.querySelector('[x-data]');
            if (element && element.__x) {
                element.__x.$data.init();
            }
        });
    </script>
</body>
</html>
